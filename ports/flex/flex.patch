diff -Paur --no-dereference -- flex.upstream/configure flex/configure
--- flex.upstream/configure
+++ flex/configure
@@ -1,4 +1,6 @@
 #! /bin/sh
+export ac_cv_func_malloc_0_nonnull=yes
+export ac_cv_func_realloc_0_nonnull=yes
 # Guess values for system-dependent variables and create Makefiles.
 # Generated by GNU Autoconf 2.69 for the fast lexical analyser generator 2.6.4.
 #
diff -Paur --no-dereference -- flex.upstream/src/Makefile.in flex/src/Makefile.in
--- flex.upstream/src/Makefile.in
+++ flex/src/Makefile.in
@@ -92,9 +92,10 @@
 host_triplet = @host@
 bin_PROGRAMS = flex$(EXEEXT)
 @ENABLE_BOOTSTRAP_TRUE@noinst_PROGRAMS = stage1flex$(EXEEXT)
-@CROSS_TRUE@am__append_1 = \
-@CROSS_TRUE@		      ../lib/malloc.c \
-@CROSS_TRUE@		      ../lib/realloc.c
+# PATCH: Always respect CC_FOR_BUILD.
+am__append_1 = \
+		      ../lib/malloc.c \
+		      ../lib/realloc.c
 
 subdir = src
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
@@ -190,13 +191,12 @@
 	stage1flex-tables.$(OBJEXT) stage1flex-tables_shared.$(OBJEXT) \
 	stage1flex-tblcmp.$(OBJEXT) stage1flex-yylex.$(OBJEXT)
 am__dirstamp = $(am__leading_dot)dirstamp
-@CROSS_TRUE@am__objects_3 = ../lib/stage1flex-malloc.$(OBJEXT) \
-@CROSS_TRUE@	../lib/stage1flex-realloc.$(OBJEXT)
+am__objects_3 = ../lib/stage1flex-malloc.$(OBJEXT) \
+	../lib/stage1flex-realloc.$(OBJEXT)
 am_stage1flex_OBJECTS = stage1flex-scan.$(OBJEXT) $(am__objects_2) \
 	$(am__objects_3)
 stage1flex_OBJECTS = $(am_stage1flex_OBJECTS)
 am__DEPENDENCIES_1 = $(LIBOBJS)
-@CROSS_FALSE@stage1flex_DEPENDENCIES = $(am__DEPENDENCIES_1)
 AM_V_P = $(am__v_P_@AM_V@)
 am__v_P_ = $(am__v_P_@AM_DEFAULT_V@)
 am__v_P_0 = false
@@ -298,7 +298,7 @@
 CCDEPMODE = @CCDEPMODE@
 CC_FOR_BUILD = @CC_FOR_BUILD@
 CFLAGS = @CFLAGS@
-CFLAGS_FOR_BUILD = @CFLAGS_FOR_BUILD@
+CFLAGS_FOR_BUILD = @CFLAGS_FOR_BUILD@ -DSTAGE1FLEX
 CPP = @CPP@
 CPPFLAGS = @CPPFLAGS@
 CPPFLAGS_FOR_BUILD = @CPPFLAGS_FOR_BUILD@
@@ -452,13 +452,10 @@
 
 libfl_la_LDFLAGS = -version-info @SHARED_VERSION_INFO@
 stage1flex_SOURCES = scan.l $(COMMON_SOURCES) $(am__append_1)
-@CROSS_FALSE@stage1flex_LDADD = $(LDADD)
-@CROSS_TRUE@stage1flex_LDADD = 
-@CROSS_FALSE@stage1flex_LINK = $(LINK)
-@CROSS_TRUE@stage1flex_LINK = $(LIBTOOL) --tag=CC --mode=link $(CC_FOR_BUILD) \
-@CROSS_TRUE@		  $(CFLAGS_FOR_BUILD) $(LDFLAGS_FOR_BUILD) -o $@
+stage1flex_LDADD = 
+stage1flex_LINK = $(LIBTOOL) --tag=CC --mode=link $(CC_FOR_BUILD) \
+		  $(CFLAGS_FOR_BUILD) $(LDFLAGS_FOR_BUILD) -o $@
 
-@CROSS_FALSE@stage1flex_CFLAGS = $(AM_CFLAGS)
 flex_SOURCES = \
 	$(COMMON_SOURCES)
 
@@ -1682,11 +1679,11 @@
 .PRECIOUS: Makefile
 
 
-@CROSS_TRUE@$(stage1flex_OBJECTS): CC=$(CC_FOR_BUILD)
-@CROSS_TRUE@$(stage1flex_OBJECTS): CFLAGS=$(CFLAGS_FOR_BUILD)
-@CROSS_TRUE@$(stage1flex_OBJECTS): CPP=$(CPP_FOR_BUILD)
-@CROSS_TRUE@$(stage1flex_OBJECTS): CPPFLAGS=$(CPPFLAGS_FOR_BUILD)
-@CROSS_TRUE@$(stage1flex_OBJECTS): LDFLAGS=$(LDFLAGS_FOR_BUILD)
+$(stage1flex_OBJECTS): CC=$(CC_FOR_BUILD)
+$(stage1flex_OBJECTS): CFLAGS=$(CFLAGS_FOR_BUILD)
+$(stage1flex_OBJECTS): CPP=$(CPP_FOR_BUILD)
+$(stage1flex_OBJECTS): CPPFLAGS=$(CPPFLAGS_FOR_BUILD)
+$(stage1flex_OBJECTS): LDFLAGS=$(LDFLAGS_FOR_BUILD)
 
 skel.c: flex.skl mkskel.sh flexint.h tables_shared.h tables_shared.c
 	$(SHELL) $(srcdir)/mkskel.sh $(srcdir) $(m4) $(VERSION) > $@.tmp
diff -Paur --no-dereference -- flex.upstream/src/config.h.in flex/src/config.h.in
--- flex.upstream/src/config.h.in
+++ flex/src/config.h.in
@@ -10,7 +10,14 @@
 
 /* Define to 1 if translation of program messages to the user's native
    language is requested. */
+/* PATCH: Unfortunately stage1flex is built on the build machine, but configure
+          does not detect how to link with libintl with CC_FOR_BUILD, causing
+          link failures when cross-compiling from a system using libintl.
+          Adding proper support to configure is too big to patch in, so instead
+          the easiest solution is to disable nls in the temporary stage1flex. */
+#ifndef STAGE1FLEX
 #undef ENABLE_NLS
+#endif
 
 /* Define to 1 if you have `alloca', as a function or macro. */
 #undef HAVE_ALLOCA
diff -Paur --no-dereference -- flex.upstream/src/main.c flex/src/main.c
--- flex.upstream/src/main.c
+++ flex/src/main.c
@@ -342,43 +342,7 @@
     /* Setup the filter chain. */
     output_chain = filter_create_int(NULL, filter_tee_header, headerfilename);
     if ( !(m4 = getenv("M4"))) {
-	    char *slash;
-		m4 = M4;
-		if ((slash = strrchr(M4, '/')) != NULL) {
-			m4 = slash+1;
-			/* break up $PATH */
-			const char *path = getenv("PATH");
-			if (!path) {
-				m4 = M4;
-			} else {
-				int m4_length = strlen(m4);
-				do {
-					size_t length = strlen(path);
-					struct stat sbuf;
-
-					const char *endOfDir = strchr(path, ':');
-					if (!endOfDir)
-						endOfDir = path+length;
-
-					{
-						char *m4_path = calloc(endOfDir-path + 1 + m4_length + 1, 1);
-
-						memcpy(m4_path, path, endOfDir-path);
-						m4_path[endOfDir-path] = '/';
-						memcpy(m4_path + (endOfDir-path) + 1, m4, m4_length + 1);
-						if (stat(m4_path, &sbuf) == 0 &&
-							(S_ISREG(sbuf.st_mode)) && sbuf.st_mode & S_IXUSR) {
-							m4 = m4_path;
-							break;
-						}
-						free(m4_path);
-					}
-					path = endOfDir+1;
-				} while (path[0]);
-				if (!path[0])
-				    m4 = M4;
-			}
-		}
+		m4 = "m4";
 	}
     filter_create_ext(output_chain, m4, "-P", 0);
     filter_create_int(output_chain, filter_fix_linedirs, NULL);
